name: Build prokube flavored MLflow OIDC Auth Image

on:
  pull_request:
  push:
    branches:
      - 'pk-build'
    tags:
      - 'v*'
  workflow_dispatch:

env:
  IMAGE_NAME: "mlflow-oidc-auth"
  IMAGE_PUSH_PATH: "${{ secrets.GCP_ARTIFACT_REGISTRY_PATH }}"
  MLFLOW_VERSION: "800fa8692f07264386fca2d8670d132474ecd5a2"

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Setup build dependencies
        run: |
          set -euo pipefail
          # ubuntu-latest comes with pip and npm
          npm install -g yarn
          pip install uv --break-system-packages

      - name: Restore MLflow build cache
        id: cache-mlflow
        uses: actions/cache/restore@v4
        with:
          path: dist/mlflow-*.tar.gz
          key: mlflow-build-${{ env.MLFLOW_VERSION }}

      - name: Restore MLflow JS node_modules cache
        if: steps.cache-mlflow.outputs.cache-hit != 'true'
        uses: actions/cache/restore@v4
        with:
          path: mlflow-upstream/mlflow/server/js/node_modules
          key: mlflow-js-${{ hashFiles('mlflow-upstream/mlflow/server/js/yarn.lock') }}

      - name: Restore web-react node_modules cache
        uses: actions/cache/restore@v4
        with:
          path: web-react/node_modules
          key: web-react-${{ hashFiles('web-react/yarn.lock') }}

      - name: Build MLflow from source
        id: build-mlflow
        if: steps.cache-mlflow.outputs.cache-hit != 'true'
        run: |
          set -euo pipefail
          cd mlflow-upstream/mlflow/server/js
          yarn install --immutable
          yarn build

          cd ../../..
          uv sync --frozen --no-install-project --no-cache
          uv build
          mkdir -p ../dist
          cp dist/mlflow-*.tar.gz ../dist/

      - name: Build mlflow-oidc-auth
        id: build-oidc-auth
        run: |
          set -euo pipefail
          cd web-react
          yarn install --immutable
          yarn build
          cd ..
          uv sync --no-install-project --no-cache
          uv build

      - name: Auth GCloud CLI
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Docker Login to Google Artifact Registry
        uses: docker/login-action@v3
        with:
          registry: europe-west3-docker.pkg.dev
          username: _json_key
          password: ${{ secrets.GCP_SA_KEY }}

      - name: Create docker image with built wheels
        id: docker-build
        run: |
          set -euo pipefail

          # Determine branch name (head_ref for PRs, ref_name for pushes)
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BRANCH_NAME="${{ github.head_ref }}"
          else
            BRANCH_NAME="${{ github.ref_name }}"
          fi

          # Sanitize branch name (replace / and other invalid chars with -)
          BRANCH_NAME=$(echo "$BRANCH_NAME" | sed 's/[^a-zA-Z0-9._-]/-/g' | sed 's/--*/-/g' | sed 's/^-//' | sed 's/-$//')

          # Generate datetime stamp
          DATETIME=$(date -u +%Y%m%d-%H%M%S)

          # Build image tags
          BRANCH_DATETIME_TAG=${{ env.IMAGE_PUSH_PATH }}/${{ env.IMAGE_NAME }}:${BRANCH_NAME}-${DATETIME}
          BRANCH_LATEST_TAG=${{ env.IMAGE_PUSH_PATH }}/${{ env.IMAGE_NAME }}:${BRANCH_NAME}-latest

          docker build --platform linux/amd64 -t $BRANCH_DATETIME_TAG .

          docker tag $BRANCH_DATETIME_TAG $BRANCH_LATEST_TAG
          docker push $BRANCH_DATETIME_TAG
          docker push $BRANCH_LATEST_TAG

          echo "Pushed image: $BRANCH_DATETIME_TAG"
          echo "Pushed image: $BRANCH_LATEST_TAG"

          # Export tags for PR comment
          echo "datetime_tag=${BRANCH_DATETIME_TAG}" >> $GITHUB_OUTPUT
          echo "latest_tag=${BRANCH_LATEST_TAG}" >> $GITHUB_OUTPUT

          # For pushes to pk-build or version tags, also push latest and version tags
          if [[ "${{ github.ref }}" == "refs/heads/pk-build" ]]; then
            LATEST_TAG=${{ env.IMAGE_PUSH_PATH }}/${{ env.IMAGE_NAME }}:latest
            docker tag $BRANCH_DATETIME_TAG $LATEST_TAG
            docker push $LATEST_TAG
            echo "Pushed image: $LATEST_TAG"
          fi

          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            GIT_TAG="${{ github.ref_name }}"
            echo "Git tag detected: $GIT_TAG"
            docker tag $BRANCH_DATETIME_TAG ${{ env.IMAGE_PUSH_PATH }}/${{ env.IMAGE_NAME }}:$GIT_TAG
            docker push ${{ env.IMAGE_PUSH_PATH }}/${{ env.IMAGE_NAME }}:$GIT_TAG
          fi

      - name: Comment on PR with image tags
        if: github.event_name == 'pull_request'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} --body "**Build succeeded!**

          **Image tags:**
          \`\`\`
          ${{ steps.docker-build.outputs.datetime_tag }}
          ${{ steps.docker-build.outputs.latest_tag }}
          \`\`\`"

      - name: Save MLflow build cache
        if: always() && steps.build-mlflow.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: dist/mlflow-*.tar.gz
          key: mlflow-build-${{ env.MLFLOW_VERSION }}

      - name: Save MLflow JS node_modules cache
        if: always() && steps.build-mlflow.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: mlflow-upstream/mlflow/server/js/node_modules
          key: mlflow-js-${{ hashFiles('mlflow-upstream/mlflow/server/js/yarn.lock') }}

      - name: Save web-react node_modules cache
        if: always() && steps.build-oidc-auth.outcome == 'success'
        uses: actions/cache/save@v4
        with:
          path: web-react/node_modules
          key: web-react-${{ hashFiles('web-react/yarn.lock') }}
